name: Post Release

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'Release PR URL (e.g., https://github.com/owner/repo/pull/123)'
        required: true
        type: string

jobs:
  post-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Determine target branch
        id: target_branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            TARGET_BRANCH="main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            TARGET_BRANCH="master"
          else
            echo "Error: Neither main nor master branch found"
            exit 1
          fi
          echo "branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "Target branch: $TARGET_BRANCH"
          
      - name: Checkout target branch
        run: |
          TARGET_BRANCH="${{ steps.target_branch.outputs.branch }}"
          git checkout "$TARGET_BRANCH"
          git pull origin "$TARGET_BRANCH"
          
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Extract PR number from URL
        id: extract_pr
        run: |
          PR_URL="${{ inputs.pr_url }}"
          
          if [[ "$PR_URL" =~ /pull/([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
          else
            echo "Error: Invalid PR URL format. Expected format: https://github.com/owner/repo/pull/123"
            exit 1
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Extracted PR number: $PR_NUMBER"
          
      - name: Get PR details
        id: get_pr_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.extract_pr.outputs.pr_number }}"
          
          PR_DATA=$(gh pr view "$PR_NUMBER" --json number,title,body,headRefName,state)
          
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.headRefName')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body')
          
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "PR Title: $PR_TITLE"
          echo "Branch: $BRANCH_NAME"
          
      - name: Extract version from PR
        id: validate_version
        run: |
          BRANCH_NAME="${{ steps.get_pr_details.outputs.branch_name }}"
          
          if [[ "$BRANCH_NAME" =~ ^release/(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "Error: Branch name '$BRANCH_NAME' doesn't match release/* pattern"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          
      - name: Create Git Tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.validate_version.outputs.version }}"
          TAG_NAME="$VERSION"
          PR_BODY="${{ steps.get_pr_details.outputs.body }}"
          
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping tag creation"
          else
            echo "$PR_BODY" | git tag -a "$TAG_NAME" -F -
            git push origin "$TAG_NAME"
            echo "Created and pushed annotated tag: $TAG_NAME"
          fi
          
      - name: Get changelog for release
        id: get_changelog
        run: |
          PR_BODY="${{ steps.get_pr_details.outputs.body }}"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.validate_version.outputs.version }}"
          TAG_NAME="$VERSION"
          RELEASE_NOTES="${{ steps.get_changelog.outputs.notes }}"
          
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release $TAG_NAME already exists, skipping release creation"
          else
            gh release create "$TAG_NAME" \
              --title "$VERSION" \
              --notes "$RELEASE_NOTES"
            echo "Created GitHub release: $TAG_NAME"
          fi
          
      - name: Merge back to development
        run: |
          TARGET_BRANCH="${{ steps.target_branch.outputs.branch }}"
          
          git fetch origin development
          git checkout development
          
          echo "Merging $TARGET_BRANCH into development"
          
          if git merge origin/$TARGET_BRANCH --no-ff -m "Merge $TARGET_BRANCH into development after release ${{ steps.validate_version.outputs.version }}"; then
            git push origin development
            echo "Successfully merged $TARGET_BRANCH back to development"
          else
            echo "Merge conflict detected. Please resolve manually."
            echo "Run the following commands locally:"
            echo "  git checkout development"
            echo "  git pull"
            echo "  git merge $TARGET_BRANCH"
            echo "  # Resolve conflicts"
            echo "  git push"
            exit 1
          fi
          
      - name: Summary
        run: |
          echo "## ✅ Post-Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.validate_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.validate_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Branch:** ${{ steps.target_branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release PR:** #${{ steps.extract_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created annotated Git tag with PR description" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created GitHub release with PR description" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Merged ${{ steps.target_branch.outputs.branch }} back to development" >> $GITHUB_STEP_SUMMARY
