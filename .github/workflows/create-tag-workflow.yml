name: Create Tag

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'Release PR URL (e.g., https://github.com/owner/repo/pull/123)'
        required: true
        type: string

jobs:
  create-tag:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Extract PR number from URL
        id: extract_pr
        run: |
          PR_URL="${{ inputs.pr_url }}"
          
          if [[ "$PR_URL" =~ /pull/([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
          else
            echo "Error: Invalid PR URL format. Expected format: https://github.com/owner/repo/pull/123"
            exit 1
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Extracted PR number: $PR_NUMBER"
          
      - name: Get PR details
        id: get_pr_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.extract_pr.outputs.pr_number }}"
          
          PR_DATA=$(gh pr view "$PR_NUMBER" --json number,title,body,headRefName,state)
          
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.headRefName')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body')
          
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "PR Title: $PR_TITLE"
          echo "Branch: $BRANCH_NAME"
          
      - name: Extract version from PR
        id: validate_version
        run: |
          BRANCH_NAME="${{ steps.get_pr_details.outputs.branch_name }}"
          
          if [[ "$BRANCH_NAME" =~ ^release/(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "Error: Branch name '$BRANCH_NAME' doesn't match release/* pattern"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          
      - name: Checkout release branch
        run: |
          BRANCH_NAME="${{ steps.get_pr_details.outputs.branch_name }}"
          
          git fetch origin
          git checkout "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME"
          
          echo "Checked out and updated release branch: $BRANCH_NAME"
          
      - name: Create Git Tag
        run: |
          VERSION="${{ steps.validate_version.outputs.version }}"
          TAG_NAME="$VERSION"
          PR_BODY="${{ steps.get_pr_details.outputs.body }}"
          
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Error: Tag $TAG_NAME already exists"
            exit 1
          fi
          
          echo "$PR_BODY" | git tag "$TAG_NAME" -a -F -
          echo "Created annotated tag: $TAG_NAME"
          
      - name: Show tag details
        run: |
          VERSION="${{ steps.validate_version.outputs.version }}"
          TAG_NAME="$VERSION"
          
          echo "Tag details:"
          git show "$TAG_NAME"
          
      - name: Push tag to origin
        run: |
          VERSION="${{ steps.validate_version.outputs.version }}"
          TAG_NAME="$VERSION"
          
          git push --tags origin
          echo "Pushed tag to origin: $TAG_NAME"
          
      - name: Summary
        run: |
          echo "## ✅ Tag Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.validate_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.validate_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Branch:** ${{ steps.get_pr_details.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release PR:** #${{ steps.extract_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Checked out release branch" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created annotated Git tag with PR description" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Pushed tag to origin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify the tag was created correctly" >> $GITHUB_STEP_SUMMARY
          echo "2. Run the post-release workflow to create the GitHub release and merge back to development" >> $GITHUB_STEP_SUMMARY
